tic
Mag = ReadAllDCM('/media/work/aelkady/3T/Ahmed_96Echo_3Dtest/study/gre_96contrasts_new_5',32);
%Phase = ReadAllDCM('/media/work/aelkady/3T/Ahmed_96Echo_3Dtest_2/study/gre_96contrasts_3avg_7',48);

%Phase = double(pi* Phase/max(Phase(:)));
Mag = double(Mag);

Info.FirstTE = 1.6e-3;
Info.EchoSpacing = 1.05e-3;
Info.Vox = [1.5 1.5 2] * 1e-3;
%[LFGCM, Gp, Gv, Gs] = LFG_Correction(Mag, Phase, Info);

Opt.T_range = [1e-3 0.150];
Opt.Number_T = 150;
E.FirstEchoTime = Info.FirstTE;
E.EchoSpacing = Info.EchoSpacing;

Fitted = NNLS_T_Batch_Fitting(Mag,E,Opt);
%LFGC_Fitted = NNLS_T_Batch_Fitting(LFGCM,E,Opt);

MWF = Find_MWF(Fitted, 25);
%LFGC_MWF = Find_MWF(LFGC_Fitted, 25);

RunT = toc;
disp('Saving results...')
% This is for linux matlab
cd ~
save('EndResults')
disp('Done!')
